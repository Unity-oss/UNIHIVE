{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Payment Management - MWF UNIHIVE{% endblock %}

{% block description %}Comprehensive payment management and tracking system for UNIHIVE rental properties{% endblock %}

{% block extra_head %}
<style>
    .payments-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 100vh;
    }
    
    .dashboard-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
    }
    
    .dashboard-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card {
        background: linear-gradient(135deg, #7400B8 0%, #9739C8 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 30px rgba(116, 0, 184, 0.3);
    }
    
    .btn-unity {
        background: linear-gradient(135deg, #7400B8 0%, #9739C8 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-unity:hover {
        background: linear-gradient(135deg, #8013BD 0%, #A24CCD 100%);
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(116, 0, 184, 0.3);
        color: white;
    }
    
    .btn-add {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }
    
    .btn-add:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        color: white;
        text-decoration: none;
    }
    
    .search-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
    }
    
    .payment-table {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .payment-table th {
        background: linear-gradient(135deg, #7400B8 0%, #9739C8 100%);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.875rem;
    }
    
    .payment-table tbody tr:hover {
        background: linear-gradient(135deg, #f8f9ff 0%, #f3f4ff 100%);
        transform: scale(1.01);
        transition: all 0.2s ease;
    }
    
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-paid {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .status-partial {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }
    
    .status-unpaid {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .payment-method-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .method-cash {
        background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        color: white;
    }
    
    .method-bank {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
    }
    
    .method-mobile {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        color: white;
    }
    
    .action-btn {
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        margin: 0 2px;
    }
    
    .action-btn:hover {
        transform: translateY(-1px);
    }
    
    .btn-view {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
    }
    
    .btn-edit {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }
    
    .btn-delete {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .modal {
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        transform: scale(0.8);
        transition: all 0.3s ease;
    }
    
    .modal.show .modal-content {
        transform: scale(1);
    }
    

    
    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .amount-display {
        font-family: 'Courier New', monospace;
        font-weight: 700;
        color: #1f2937;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
    }
    
    .pagination .page-link {
        padding: 8px 12px;
        border-radius: 6px;
        text-decoration: none;
        color: #6b7280;
        border: 1px solid #d1d5db;
        transition: all 0.2s ease;
    }
    
    .pagination .page-link:hover,
    .pagination .page-link.active {
        background: linear-gradient(135deg, #7400B8 0%, #9739C8 100%);
        color: white;
        border-color: #7400B8;
    }
</style>
{% endblock %}

{% block content %}
<div class="payments-container py-8 px-4" 
     data-payment-details-url="{% url 'payments:payment_details_api' 0 %}"
     data-payment-delete-url="{% url 'payments:delete_payment' 0 %}">
    <div class="max-w-7xl mx-auto">
        <!-- Header Section -->
        <div class="fade-in mb-8">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">Payment Management</h1>
                    <p class="text-gray-600">Track and manage all rental payments efficiently</p>
                </div>
                <div class="flex space-x-3">
                    <a href="{% url 'payments:add_payment' %}" 
                       class="btn-add text-white font-bold py-3 px-6 rounded-lg flex items-center transition-all duration-300">
                        <i class="fas fa-plus mr-2"></i>
                        Record New Payment
                    </a>
                </div>
            </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 fade-in">
            <div class="stat-card">
                <div class="flex items-center justify-between mb-2">
                    <i class="fas fa-money-bill-wave text-2xl opacity-80"></i>
                    <span class="text-sm opacity-80">Total</span>
                </div>
                <div class="text-2xl font-bold">{{ total_payments }}</div>
                <div class="text-sm opacity-80">Payments</div>
            </div>
            
            <div class="stat-card">
                <div class="flex items-center justify-between mb-2">
                    <i class="fas fa-check-circle text-2xl opacity-80"></i>
                    <span class="text-sm opacity-80">Paid</span>
                </div>
                <div class="text-2xl font-bold">UGX {{ total_amount_paid|floatformat:0 }}</div>
                <div class="text-sm opacity-80">Total Received</div>
            </div>
            
            <div class="stat-card">
                <div class="flex items-center justify-between mb-2">
                    <i class="fas fa-clock text-2xl opacity-80"></i>
                    <span class="text-sm opacity-80">Pending</span>
                </div>
                <div class="text-2xl font-bold">UGX {{ total_amount_due|floatformat:0 }}</div>
                <div class="text-sm opacity-80">Outstanding</div>
            </div>
            
            <div class="stat-card">
                <div class="flex items-center justify-between mb-2">
                    <i class="fas fa-calendar-alt text-2xl opacity-80"></i>
                    <span class="text-sm opacity-80">This Month</span>
                </div>
                <div class="text-2xl font-bold">{{ this_month_payments }}</div>
                <div class="text-sm opacity-80">Payments</div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-container p-6 mb-8 fade-in">
            <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-search mr-2 text-Unity-Purple"></i>
                Search Payments
            </h3>
            {% crispy search_form %}
        </div>

        <!-- Payments Table -->
        <div class="dashboard-card fade-in">
            <div class="overflow-x-auto">
                <table class="payment-table w-full">
                    <thead>
                        <tr>
                            <th class="px-6 py-4 text-left">Payment ID</th>
                            <th class="px-6 py-4 text-left">Tenant</th>
                            <th class="px-6 py-4 text-left">Rental</th>
                            <th class="px-6 py-4 text-center">Amount Paid</th>
                            <th class="px-6 py-4 text-center">Amount Due</th>
                            <th class="px-6 py-4 text-center">Balance</th>
                            <th class="px-6 py-4 text-center">Payment Date</th>
                            <th class="px-6 py-4 text-center">Method</th>
                            <th class="px-6 py-4 text-center">Status</th>
                            <th class="px-6 py-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payments %}
                        <tr>
                            <td class="px-6 py-4 font-mono text-sm font-bold text-Unity-Purple">
                                {{ payment.payment_id }}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <i class="fas fa-user text-gray-400 mr-2"></i>
                                    <span class="font-medium">{{ payment.tenant.name }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <i class="fas fa-home text-gray-400 mr-2"></i>
                                    <span>{{ payment.rental.property.property_name }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="amount-display text-green-600">
                                    UGX {{ payment.amount|floatformat:0 }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="amount-display text-red-600">
                                    UGX {{ payment.amount_due|floatformat:0 }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="amount-display text-orange-600" id="balance-{{ payment.payment_id }}">
                                    UGX {{ payment.amount_due|floatformat:0 }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-calendar-alt text-gray-400 mr-2"></i>
                                    <span>{{ payment.payment_date|date:"M d, Y" }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if payment.payment_method == "Cash" %}
                                    <span class="payment-method-badge method-cash">
                                        <i class="fas fa-money-bill"></i>
                                        Cash
                                    </span>
                                {% elif payment.payment_method == "Bank Transfer" %}
                                    <span class="payment-method-badge method-bank">
                                        <i class="fas fa-university"></i>
                                        Bank
                                    </span>
                                {% elif payment.payment_method == "Mobile Money" %}
                                    <span class="payment-method-badge method-mobile">
                                        <i class="fas fa-mobile-alt"></i>
                                        Mobile
                                    </span>
                                {% else %}
                                    <span class="payment-method-badge bg-gray-500 text-white">
                                        <i class="fas fa-question"></i>
                                        {{ payment.payment_method }}
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if payment.amount_due <= payment.amount %}
                                    <span class="status-badge status-paid">Paid</span>
                                {% elif payment.amount > 0 %}
                                    <span class="status-badge status-partial">Partial</span>
                                {% else %}
                                    <span class="status-badge status-unpaid">Unpaid</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex justify-center space-x-1">
                                    <button data-payment-id="{{ payment.payment_id }}" 
                                            class="action-btn btn-view btn-view-payment" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="{% url 'payments:edit_payment' payment.payment_id %}" 
                                       class="action-btn btn-edit" title="Edit Payment">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button data-payment-id="{{ payment.payment_id }}" 
                                            class="action-btn btn-delete btn-delete-payment" title="Delete Payment">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-money-bill-wave text-4xl mb-4 opacity-50"></i>
                                {% if search_form.search.value %}
                                    <p class="text-lg font-medium">No payments found</p>
                                    <p class="text-sm">No payments match your search criteria. Try adjusting your search terms.</p>
                                {% else %}
                                    <p class="text-lg font-medium">No payments found</p>
                                    <p class="text-sm">Start by recording your first payment</p>
                                {% endif %}
                                <div class="mt-4 space-x-2">
                                    {% if search_form.search.value %}
                                        <a href="{% url 'payments:payment_list' %}" 
                                           class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg inline-flex items-center transition duration-200">
                                            <i class="fas fa-times mr-2"></i>
                                            Clear Search
                                        </a>
                                    {% endif %}
                                    <a href="{% url 'payments:add_payment' %}" class="btn-add inline-block">
                                        <i class="fas fa-plus mr-2"></i>
                                        Record First Payment
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        {% if payments.has_other_pages %}
        <div class="pagination fade-in">
            {% if payments.has_previous %}
                <a href="?page=1" class="page-link">First</a>
                <a href="?page={{ payments.previous_page_number }}" class="page-link">Previous</a>
            {% endif %}
            
            {% for num in payments.paginator.page_range %}
                {% if payments.number == num %}
                    <span class="page-link active">{{ num }}</span>
                {% elif num > payments.number|add:'-3' and num < payments.number|add:'3' %}
                    <a href="?page={{ num }}" class="page-link">{{ num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if payments.has_next %}
                <a href="?page={{ payments.next_page_number }}" class="page-link">Next</a>
                <a href="?page={{ payments.paginator.num_pages }}" class="page-link">Last</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- View Payment Modal -->
<div id="viewModal" class="modal fixed inset-0 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="modal-content w-full max-w-2xl">
            <div class="bg-Unity-Purple text-white px-6 py-4 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">Payment Details</h3>
                    <button onclick="hideModal('viewModal')" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6" id="viewModalContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal fixed inset-0 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="modal-content w-full max-w-md">
            <div class="bg-red-600 text-white px-6 py-4 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">Confirm Deletion</h3>
                    <button onclick="hideModal('deleteModal')" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <p class="text-lg font-medium mb-2">Are you sure?</p>
                    <p class="text-gray-600 mb-6">This action cannot be undone. The payment record will be permanently deleted.</p>
                    <div class="flex gap-4 justify-center">
                        <button onclick="hideModal('deleteModal')" 
                                class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                            Cancel
                        </button>
                        <form id="deleteForm" method="post" class="inline">
                            {% csrf_token %}
                            <button type="submit" 
                                    class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                Delete Payment
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
            document.body.style.overflow = 'hidden';
        }
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }, 300);
        }
    }

    function viewPayment(paymentId) {
        // Get the base URL from data attribute and replace the placeholder
        const container = document.querySelector('.payments-container');
        const baseUrl = container.getAttribute('data-payment-details-url');
        const apiUrl = baseUrl.replace('0', paymentId);
        
        // Fetch payment details via AJAX
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                const content = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-gray-600">Payment ID</label>
                                <div class="text-lg font-bold text-Unity-Purple">${data.payment_id}</div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Payment Date</label>
                                <div class="text-lg">${new Date(data.payment_date).toLocaleDateString()}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-gray-600">Tenant</label>
                                <div class="text-lg">${data.tenant_name}</div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Property</label>
                                <div class="text-lg">${data.property_name}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-gray-600">Amount Paid</label>
                                <div class="text-xl font-bold text-green-600">UGX ${data.amount.toLocaleString()}</div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Amount Due</label>
                                <div class="text-xl font-bold text-red-600">UGX ${data.amount_due.toLocaleString()}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-gray-600">Payment Method</label>
                                <div class="text-lg">${data.payment_method}</div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Balance Remaining</label>
                                <div class="text-xl font-bold ${data.amount_due <= data.amount ? 'text-green-600' : 'text-orange-600'}">
                                    UGX ${Math.max(0, data.amount_due - data.amount).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('viewModalContent').innerHTML = content;
                showModal('viewModal');
            })
            .catch(error => {
                console.error('Error fetching payment details:', error);
                alert('Failed to load payment details. Please try again.');
            });
    }

    function deletePayment(paymentId) {
        // Get the base URL from data attribute and replace the placeholder
        const container = document.querySelector('.payments-container');
        const baseUrl = container.getAttribute('data-payment-delete-url');
        const deleteUrl = baseUrl.replace('0', paymentId);
        
        const deleteForm = document.getElementById('deleteForm');
        deleteForm.action = deleteUrl;
        showModal('deleteModal');
    }

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            hideModal(e.target.id);
        }
    });

    // Initialize tooltips and other interactive elements
    document.addEventListener('DOMContentLoaded', function() {
        // Add smooth scrolling
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
        
        // Initialize fade-in animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);
        
        document.querySelectorAll('.fade-in').forEach(el => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(20px)';
            el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            observer.observe(el);
        });
        
        // Add event listeners for view and delete buttons
        document.querySelectorAll('.btn-view-payment').forEach(button => {
            button.addEventListener('click', function() {
                const paymentId = this.getAttribute('data-payment-id');
                viewPayment(paymentId);
            });
        });
        
        document.querySelectorAll('.btn-delete-payment').forEach(button => {
            button.addEventListener('click', function() {
                const paymentId = this.getAttribute('data-payment-id');
                deletePayment(paymentId);
            });
        });
        
        // Calculate and display correct balances
        calculateBalances();
        
        // Add smooth scrolling for search results
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                // Clear any previous timeout
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    // Optional: Auto-submit search after typing stops
                    // this.form.submit();
                }, 500);
            });
        }
    });
    
    function calculateBalances() {
        // Find all payment rows and calculate balances
        const paymentRows = document.querySelectorAll('tbody tr');
        paymentRows.forEach(row => {
            const amountPaidElement = row.querySelector('.amount-display.text-green-600');
            const amountDueElement = row.querySelector('.amount-display.text-red-600');
            const balanceElement = row.querySelector('[id^="balance-"]');
            
            if (amountPaidElement && amountDueElement && balanceElement) {
                // Extract amounts from text content
                const amountPaidText = amountPaidElement.textContent.replace(/[^0-9]/g, '');
                const amountDueText = amountDueElement.textContent.replace(/[^0-9]/g, '');
                
                const amountPaid = parseFloat(amountPaidText) || 0;
                const amountDue = parseFloat(amountDueText) || 0;
                
                const balance = Math.max(0, amountDue - amountPaid);
                
                // Update balance display
                balanceElement.textContent = `UGX ${balance.toLocaleString()}`;
                
                // Update color based on balance
                if (balance === 0) {
                    balanceElement.className = 'amount-display text-green-600';
                } else {
                    balanceElement.className = 'amount-display text-orange-600';
                }
            }
        });
    }
</script>
{% endblock %}
